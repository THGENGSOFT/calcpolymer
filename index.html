<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tabela Geral Pollymer</title>
    <style>
        :root {
            --primary-color: #2c3e50;
            --accent-color: #3498db;
            --success-color: #27ae60;
            --highlight-bg: #e8f6f3;
            --border-color: #e0e0e0;
        }

        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f0f2f5; color: #333; margin: 0; padding-bottom: 100px; }
        
        /* Header e Controles */
        header { background-color: #fff; padding: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 1000; }
        .header-content { max-width: 1200px; margin: 0 auto; display: flex; flex-direction: column; gap: 15px; }
        h1 { margin: 0; color: var(--primary-color); font-size: 1.5rem; text-align: center; }
        
        .controls { display: flex; gap: 10px; flex-wrap: wrap; justify-content: space-between; }
        .search-box { flex: 1; min-width: 200px; position: relative; }
        .search-box input { width: 100%; padding: 12px 15px; border: 1px solid #ccc; border-radius: 6px; font-size: 1rem; box-sizing: border-box; }
        
        .btn-reset { padding: 10px 20px; background-color: #e74c3c; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; }
        .btn-reset:hover { background-color: #c0392b; }

        /* Tabela e Layout */
        .container { max-width: 1200px; margin: 20px auto; background: #fff; padding: 0; box-shadow: 0 0 15px rgba(0,0,0,0.05); border-radius: 8px; overflow: hidden; }
        
        .category-block { margin-bottom: 0; }
        .category-header { background-color: var(--primary-color); color: white; padding: 12px 20px; font-weight: bold; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .category-subtotal { background: rgba(255,255,255,0.2); padding: 4px 10px; border-radius: 4px; font-size: 0.9em; }

        .table-responsive { overflow-x: auto; -webkit-overflow-scrolling: touch; }
        table { width: 100%; border-collapse: collapse; min-width: 800px; }
        
        th, td { padding: 10px; border-bottom: 1px solid var(--border-color); text-align: left; vertical-align: middle; }
        th { background-color: #f8f9fa; color: #555; font-weight: 600; font-size: 0.85rem; text-transform: uppercase; }
        
        /* Colunas */
        .col-img { width: 60px; text-align: center; }
        .col-ref { width: 80px; text-align: center; color: #777; font-size: 0.9em; }
        .col-desc { font-weight: 500; }
        .col-emb, .col-ipi { text-align: center; color: #777; font-size: 0.9em; width: 60px; }
        .col-price { text-align: right; width: 100px; font-weight: 600; }
        .col-qty { text-align: center; width: 110px; }
        .col-total { text-align: right; width: 120px; font-weight: bold; color: var(--success-color); }

        /* Imagens e Zoom */
        .product-thumb { 
            width: 50px; 
            height: 50px; 
            object-fit: cover; 
            border-radius: 4px; 
            cursor: zoom-in; 
            border: 1px solid #ddd;
            background-color: #fff;
            transition: transform 0.2s;
        }
        .product-thumb:hover { transform: scale(1.1); }

        /* Modal de Zoom */
        .image-modal {
            display: none; 
            position: fixed; 
            z-index: 9999; 
            left: 0; top: 0; 
            width: 100%; height: 100%; 
            overflow: auto; 
            background-color: rgba(0,0,0,0.9); 
            animation: fadeIn 0.3s;
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            margin: auto;
            display: block;
            max-width: 90%;
            max-height: 90vh;
            border-radius: 5px;
            box-shadow: 0 0 20px rgba(255,255,255,0.2);
        }
        .close-modal {
            position: absolute;
            top: 20px;
            right: 35px;
            color: #f1f1f1;
            font-size: 40px;
            font-weight: bold;
            transition: 0.3s;
            cursor: pointer;
        }
        .close-modal:hover { color: #bbb; }

        @keyframes fadeIn { from {opacity: 0;} to {opacity: 1;} }

        /* Inputs e Estados */
        input[type="number"] { width: 70px; padding: 8px; border: 1px solid #ccc; border-radius: 4px; text-align: center; font-size: 1.1em; transition: all 0.2s; }
        input[type="number"]:focus { border-color: var(--accent-color); outline: none; background-color: #eaf2f8; box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2); }
        
        tr.active-row { background-color: var(--highlight-bg); }
        tr.active-row .col-desc { color: var(--success-color); }
        tr:hover { background-color: #fafafa; }

        /* Barra de Totais Fixa (Footer) */
        .total-bar { position: fixed; bottom: 0; left: 0; right: 0; background-color: #fff; padding: 15px 20px; box-shadow: 0 -5px 20px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; z-index: 1000; border-top: 1px solid #eee; }
        
        .totals-group { display: flex; gap: 30px; }
        .total-item { display: flex; flex-direction: column; }
        .total-item span { font-size: 0.75rem; color: #888; text-transform: uppercase; letter-spacing: 0.5px; }
        .total-item strong { font-size: 1.2rem; color: var(--primary-color); }
        #grand-total-final { color: var(--success-color); font-size: 1.4rem; }

        .action-group { display: flex; gap: 10px; }
        .btn-whatsapp { background-color: #25D366; color: white; padding: 10px 20px; border-radius: 50px; text-decoration: none; font-weight: bold; display: flex; align-items: center; gap: 8px; border: none; cursor: pointer; box-shadow: 0 4px 6px rgba(37, 211, 102, 0.2); transition: transform 0.1s; }
        .btn-whatsapp:active { transform: scale(0.98); }

        /* Mobile */
        @media (max-width: 768px) {
            .controls { flex-direction: column; }
            .totals-group { gap: 10px; }
            .total-item strong { font-size: 1rem; }
            #grand-total-final { font-size: 1.1rem; }
            .col-ipi, .col-emb, .col-ref { display: none; }
            .btn-whatsapp span { display: none; }
            .btn-whatsapp::after { content: " Enviar"; }
            h1 { font-size: 1.2rem; }
            .category-header { font-size: 0.95rem; }
            
            /* Ajuste imagens mobile */
            .col-img { width: 50px; }
            .product-thumb { width: 40px; height: 40px; }
        }
    </style>
</head>
<body>

<header>
    <div class="header-content">
        <h1>MMB - POLLYMER üìä</h1>
        <div class="controls">
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="üîç Buscar produto (nome ou ref)..." onkeyup="filterProducts()">
            </div>
            <button class="btn-reset" onclick="resetForm()">üóëÔ∏è Limpar Tudo</button>
        </div>
    </div>
</header>

<div class="container" id="app">
    </div>

<div id="imageModal" class="image-modal" onclick="closeImage()">
    <span class="close-modal">&times;</span>
    <img class="modal-content" id="img01">
</div>

<div class="total-bar">
    <div class="totals-group">
        <div class="total-item mobile-hide">
            <span>Total Prod.</span>
            <strong id="grand-total-products">R$ 0,00</strong>
        </div>
        <div class="total-item mobile-hide">
            <span>Total IPI</span>
            <strong id="grand-total-ipi">R$ 0,00</strong>
        </div>
        <div class="total-item">
            <span>TOTAL GERAL</span>
            <strong id="grand-total-final">R$ 0,00</strong>
        </div>
    </div>
    <div class="action-group">
        <button class="btn-whatsapp" onclick="generateWhatsApp()">
            üì± <span>Gerar Pedido</span>
        </button>
    </div>
</div>

<script>
    // --- DADOS ---
    const rawData = [
        // UTILIDADES DOM√âSTICAS
        { cat: "UTILIDADES DOM√âSTICAS", ref: "1002/12", desc: "Cabide de Roupa Pr√°tico Infantil 1 unid - Cor", emb: 60, ipi: 0.065, price: 1.18 },
        { cat: "UTILIDADES DOM√âSTICAS", ref: "1002/52", desc: "Cabide de Roupa Pr√°tico Infantil cart c/5unid - Cor", emb: 12, ipi: 0.065, price: 4.39 },
        { cat: "UTILIDADES DOM√âSTICAS", ref: "1006/11", desc: "Cabide de Roupa Adulto 1 unidade - Preto", emb: 60, ipi: 0.065, price: 0.71 },
        { cat: "UTILIDADES DOM√âSTICAS", ref: "1006/41", desc: "Cabide de Roupa Adulto cart. c/4 unidades - Preto", emb: 12, ipi: 0.065, price: 3.34 },
        { cat: "UTILIDADES DOM√âSTICAS", ref: "1006/151", desc: "Cabide de Roupa Adulto Amarr c/ 15 unidades - Preto", emb: 5, ipi: 0.065, price: 11.13 },
        { cat: "UTILIDADES DOM√âSTICAS", ref: "1010", desc: "P√° para lixo - Cor", emb: 12, ipi: 0.065, price: 3.66 },
        { cat: "UTILIDADES DOM√âSTICAS", ref: "1011", desc: "Tabua Grande para Carne - Branca", emb: 12, ipi: 0.065, price: 11.50 },
        { cat: "UTILIDADES DOM√âSTICAS", ref: "1012", desc: "Tabua Pequena para Carne - Branca", emb: 12, ipi: 0.065, price: 9.14 },
        { cat: "UTILIDADES DOM√âSTICAS", ref: "1013", desc: "Kit T√°bua (1011+1013) - Branca", emb: 12, ipi: 0.065, price: 19.55 },
        { cat: "UTILIDADES DOM√âSTICAS", ref: "1023", desc: "Porta Miudezas c/3 estojos", emb: 12, ipi: 0.065, price: 7.53 },
        { cat: "UTILIDADES DOM√âSTICAS", ref: "1024", desc: "Porta Miudezas c/4 estojos", emb: 12, ipi: 0.065, price: 9.65 },
        { cat: "UTILIDADES DOM√âSTICAS", ref: "1025", desc: "Porta Miudezas c/5 estojos", emb: 12, ipi: 0.065, price: 11.78 },
        { cat: "UTILIDADES DOM√âSTICAS", ref: "1033/48", desc: "Prendedor de Roupa Pct c/48 unidades - Cor", emb: 12, ipi: 0.065, price: 7.35 },
        { cat: "UTILIDADES DOM√âSTICAS", ref: "1033/72", desc: "Prendedor de Roupa Pct c/72 unidades - Cor", emb: 12, ipi: 0.065, price: 10.89 },
        { cat: "UTILIDADES DOM√âSTICAS", ref: "1038", desc: "Tampa para micro", emb: 24, ipi: 0.065, price: 4.70 },

        // PET SHOP
        { cat: "PET SHOP", ref: "2100", desc: "Kit Gato (bandeja+p√° higi√™nica+comedouro)", emb: 6, ipi: 0.065, price: 10.80 },
        { cat: "PET SHOP", ref: "2102", desc: "Kit 1 Comedouro Osso (2139) + 1 Comedouro Pequeno (2142)", emb: 6, ipi: 0.0975, price: 9.05 },
        { cat: "PET SHOP", ref: "2103", desc: "Kit 1 Comedouro Mini (2141) + 1 Comedouro Pequeno (2143)", emb: 6, ipi: 0.0975, price: 6.79 },
        { cat: "PET SHOP", ref: "2104", desc: "Kit 1 Pa Dosadora (2148) +2 Comed (2751) +1 Pa Higienica (2752)", emb: 12, ipi: 0.065, price: 11.25 },
        { cat: "PET SHOP", ref: "2105", desc: "Kit 1 Comedouro Slim Filhote (2701) + 1 Com Slim Medio (2703)", emb: 6, ipi: 0.0975, price: 11.96 },
        { cat: "PET SHOP", ref: "2106", desc: "Kit 2 Com Carinha Gato (2751) + 1 Pa Hig Carinha Gato (2752)", emb: 12, ipi: 0.0975, price: 10.31 },
        { cat: "PET SHOP", ref: "2107", desc: "Kit 2 Comedouro Slim Mini (2701) + 2 Bolinha Guizo (2754)", emb: 6, ipi: 0.0975, price: 10.81 },
        { cat: "PET SHOP", ref: "2139", desc: "Comedouro osso 0,75 lts", emb: 12, ipi: 0.0975, price: 4.16 },
        { cat: "PET SHOP", ref: "2140", desc: "Comedouro Hamster 0,06 lts", emb: 24, ipi: 0.0975, price: 0.83 },
        { cat: "PET SHOP", ref: "2141", desc: "Comedouro Mini 0,40 lts", emb: 12, ipi: 0.0975, price: 2.25 },
        { cat: "PET SHOP", ref: "2142", desc: "Comedouro Pequeno 0,60 lts", emb: 12, ipi: 0.0975, price: 3.43 },
        { cat: "PET SHOP", ref: "2143", desc: "Comedouro M√©dio 1,10 lts", emb: 12, ipi: 0.0975, price: 4.51 },
        { cat: "PET SHOP", ref: "2144", desc: "Comedouro Grande 2,00 lts", emb: 12, ipi: 0.0975, price: 5.81 },
        { cat: "PET SHOP", ref: "2145", desc: "Comedouro para Caes Orelhas Longas 0,60 lts", emb: 12, ipi: 0.0975, price: 4.61 },
        { cat: "PET SHOP", ref: "2146", desc: "Comedouro de Gato 0,15 lts", emb: 12, ipi: 0.0975, price: 1.74 },
        { cat: "PET SHOP", ref: "2147", desc: "Bandeja para Granulado", emb: 12, ipi: 0.065, price: 7.21 },
        { cat: "PET SHOP", ref: "2148", desc: "P√° Dosadora", emb: 24, ipi: 0.065, price: 1.88 },
        { cat: "PET SHOP", ref: "2149", desc: "P√° Higi√™nica", emb: 24, ipi: 0.065, price: 1.53 },
        { cat: "PET SHOP", ref: "2150", desc: "Fresbee", emb: 12, ipi: 0.0975, price: 4.21 },
        { cat: "PET SHOP", ref: "2151", desc: "Bandeja para Granulado - Grande - 18lts", emb: 12, ipi: 0.065, price: 14.71 },
        { cat: "PET SHOP", ref: "2152", desc: "Toalete Pet", emb: 12, ipi: 0.065, price: 21.34 },
        { cat: "PET SHOP", ref: "2513", desc: "Porta Ra√ß√£o c/3 Estojos", emb: 12, ipi: 0.065, price: 7.53 },
        { cat: "PET SHOP", ref: "2601", desc: "Comedouro Translucido Filhote - 0,17lts", emb: 12, ipi: 0.0975, price: 3.64 },
        { cat: "PET SHOP", ref: "2602", desc: "Comedouro Translucido Pequeno - 0,45lts", emb: 12, ipi: 0.0975, price: 5.93 },
        { cat: "PET SHOP", ref: "2701", desc: "Comedouro Slim Filhote - 0,15lts", emb: 12, ipi: 0.0975, price: 2.75 },
        { cat: "PET SHOP", ref: "2702", desc: "Comedouro Slim Pequeno - 0,50lts", emb: 12, ipi: 0.0975, price: 4.46 },
        { cat: "PET SHOP", ref: "2703", desc: "Comedouro Slim M√©dio - 1lts", emb: 12, ipi: 0.0975, price: 7.66 },
        { cat: "PET SHOP", ref: "2750", desc: "Kit Carinha de Gato", emb: 8, ipi: 0.065, price: 25.23 },
        { cat: "PET SHOP", ref: "2751", desc: "Comedouro Carinha de Gato - 0,14lts", emb: 12, ipi: 0.0975, price: 3.06 },
        { cat: "PET SHOP", ref: "2752", desc: "P√° Higienica Carinha de Gato", emb: 24, ipi: 0.065, price: 3.23 },
        { cat: "PET SHOP", ref: "2753", desc: "Bandeja Carinha de Gato - 10lts", emb: 12, ipi: 0.065, price: 15.99 },
        { cat: "PET SHOP", ref: "2754", desc: "Bolinha com Guizo", emb: 36, ipi: 0.0975, price: 2.04 },
        { cat: "PET SHOP", ref: "2755", desc: "Comedouro Postura Ideal - 0,200lts", emb: 12, ipi: 0.0975, price: 6.69 },
        { cat: "PET SHOP", ref: "2802", desc: "Caixa Transportadora - Grade Pl√°stica", emb: 6, ipi: 0.0975, price: 64.04 },

        // FEMININA
        { cat: "FEMININA", ref: "3901", desc: "Mini Bag Fashion c/bandeja - Cor", emb: 12, ipi: 0.065, price: 23.94 },
        { cat: "FEMININA", ref: "3905", desc: "Lady Case - Cor", emb: 24, ipi: 0.065, price: 4.83 },
        { cat: "FEMININA", ref: "3907", desc: "Mini Bag Fashion - s/bandeja - Cor", emb: 12, ipi: 0.065, price: 20.06 },
        { cat: "FEMININA", ref: "3952", desc: "Fashion Bag 2 Bandejas - Cor", emb: 6, ipi: 0.065, price: 59.11 },
        { cat: "FEMININA", ref: "3953", desc: "Fashion Bag 3 Bandejas - Cor", emb: 6, ipi: 0.065, price: 65.10 },
        { cat: "FEMININA", ref: "3954", desc: "Mini Maleta - Cor", emb: 12, ipi: 0.065, price: 5.58 },
        { cat: "FEMININA", ref: "3955", desc: "Kit 2 Mini Maletas (3954)", emb: 12, ipi: 0.065, price: 11.01 },
        { cat: "FEMININA", ref: "3956", desc: "Kit 1 Mini Maleta (3954) + 1 Mini Maleta S.O.S (8012)", emb: 12, ipi: 0.065, price: 11.34 },
        { cat: "FEMININA", ref: "3957", desc: "Kit 3 Estojos Mini Color (3905)", emb: 9, ipi: 0.065, price: 13.90 },
        { cat: "FEMININA", ref: "3958", desc: "Fashion Bag s/ Bandeja - Estojo na Tampa", emb: 12, ipi: 0.065, price: 36.89 },
        { cat: "FEMININA", ref: "3959", desc: "Fashion Bag c/ Bandeja Removivel - Estojo na Tampa", emb: 12, ipi: 0.065, price: 47.53 },
        { cat: "FEMININA", ref: "3960", desc: "Fashion Bag 1 Estojo Articulado - Estojo na Tampa", emb: 12, ipi: 0.065, price: 47.83 },

        // FERRAMENTA E PESCA
        { cat: "FERRAMENTA E PESCA", ref: "4000", desc: "KIT 1 Maleta Mini Standart (4001) + 2 Mini Estojos (4020)", emb: 12, ipi: 0.065, price: 11.94 },
        { cat: "FERRAMENTA E PESCA", ref: "4001", desc: "Maleta Mini Standart s/bandeja - Preta", emb: 24, ipi: 0.065, price: 6.55 },
        { cat: "FERRAMENTA E PESCA", ref: "4002", desc: "Maleta Mini Toolcase (Parafusadeira) - Preta", emb: 12, ipi: 0.065, price: 8.05 },
        { cat: "FERRAMENTA E PESCA", ref: "4003", desc: "Maleta M√©dia Toolcase (Furadeira) - Preta", emb: 12, ipi: 0.065, price: 12.99 },
        { cat: "FERRAMENTA E PESCA", ref: "4013", desc: "Estojo Mini-Box c/bandeja - Preto", emb: 24, ipi: 0.065, price: 6.21 },
        { cat: "FERRAMENTA E PESCA", ref: "4016", desc: "Maleta Pr√°tica Grande - Fundo Preto e Tampa Transp", emb: 12, ipi: 0.065, price: 14.13 },
        { cat: "FERRAMENTA E PESCA", ref: "4017", desc: "Organizador Multibox M√©dio - Fundo Preto e Tampa Transp", emb: 12, ipi: 0.065, price: 9.49 },
        { cat: "FERRAMENTA E PESCA", ref: "4019", desc: "Organizador Doublebox - Estrutura Preta e Tampa Transp", emb: 6, ipi: 0.065, price: 30.84 },
        { cat: "FERRAMENTA E PESCA", ref: "4020", desc: "Mini Estojo p/ Ferramentas - Preto", emb: 24, ipi: 0.065, price: 3.05 },
        { cat: "FERRAMENTA E PESCA", ref: "4029", desc: "Porta Treco c/5 estojos - Estrutura Transp Tampa Preta", emb: 12, ipi: 0.065, price: 11.78 },
        { cat: "FERRAMENTA E PESCA", ref: "4030", desc: "Maleta Master 20\" c/bandeja remov√≠vel - Preta", emb: 9, ipi: 0.065, price: 41.04 },
        { cat: "FERRAMENTA E PESCA", ref: "4033", desc: "Utility Box - Preta", emb: 12, ipi: 0.065, price: 24.10 },
        { cat: "FERRAMENTA E PESCA", ref: "4035", desc: "Maleta Master Better 20\" - Preta", emb: 9, ipi: 0.065, price: 50.43 },
        { cat: "FERRAMENTA E PESCA", ref: "4037", desc: "Maleta Master 16\" s/bandeja - Preta", emb: 12, ipi: 0.065, price: 19.19 },
        { cat: "FERRAMENTA E PESCA", ref: "4038", desc: "Maleta Master 16\" c/band remov√≠vel - Preta", emb: 12, ipi: 0.065, price: 23.54 },
        { cat: "FERRAMENTA E PESCA", ref: "4039", desc: "Maleta Max Utility Box - Preta", emb: 12, ipi: 0.065, price: 25.86 },
        { cat: "FERRAMENTA E PESCA", ref: "4042", desc: "Maleta Premium 2 Bandejas - Preta", emb: 6, ipi: 0.065, price: 32.76 },
        { cat: "FERRAMENTA E PESCA", ref: "4043", desc: "Maleta Premium 3 Bandejas - Preta", emb: 6, ipi: 0.065, price: 36.09 },
        { cat: "FERRAMENTA E PESCA", ref: "4044", desc: "Maleta Premium 2 Bandejas - Tampa Cor", emb: 6, ipi: 0.065, price: 36.28 },
        { cat: "FERRAMENTA E PESCA", ref: "4045", desc: "Maleta Premium 3 Bandejas - Tampa Cor", emb: 6, ipi: 0.065, price: 39.73 },
        { cat: "FERRAMENTA E PESCA", ref: "4046", desc: "Mini Maleta - Preta", emb: 12, ipi: 0.065, price: 3.84 },
        { cat: "FERRAMENTA E PESCA", ref: "4047", desc: "Maleta Premiun s/ Bandeja - Preta", emb: 12, ipi: 0.065, price: 18.63 },
        { cat: "FERRAMENTA E PESCA", ref: "4048", desc: "Maleta Premiun c/ 1 Bandeja Articulada - Preta", emb: 12, ipi: 0.065, price: 25.96 },
        { cat: "FERRAMENTA E PESCA", ref: "4049", desc: "Maleta Premiun s/ Bandeja - Tampa Cor", emb: 12, ipi: 0.065, price: 20.85 },
        { cat: "FERRAMENTA E PESCA", ref: "4050", desc: "Maleta Premiun c/ 1 Bandeja Art - Tampa Cor", emb: 12, ipi: 0.065, price: 28.11 },
        { cat: "FERRAMENTA E PESCA", ref: "4051", desc: "Maleta Premiun c/ Bandeja Remov√≠vel - Preta", emb: 12, ipi: 0.065, price: 22.78 },
        { cat: "FERRAMENTA E PESCA", ref: "4052", desc: "Maleta Premiun c/ Band Removivel - Tampa Cor", emb: 12, ipi: 0.065, price: 25.55 },
        { cat: "FERRAMENTA E PESCA", ref: "4054", desc: "Maleta Premium Toolcase sem estojo - Preta", emb: 12, ipi: 0.065, price: 19.39 },
        { cat: "FERRAMENTA E PESCA", ref: "4055", desc: "Maleta Premium Toolcase com estojo - Preta", emb: 12, ipi: 0.065, price: 28.44 },
        { cat: "FERRAMENTA E PESCA", ref: "4056", desc: "Balde Pedreiro Reforcado - 12lts - Preto", emb: 24, ipi: 0.0325, price: 7.40 },
        { cat: "FERRAMENTA E PESCA", ref: "4057", desc: "Maleta Special Box - Serra Marmore - Preta", emb: 12, ipi: 0.065, price: 20.99 },
        { cat: "FERRAMENTA E PESCA", ref: "4058", desc: "Maleta Serra Marmore - Preta - Alca 16\"", emb: 12, ipi: 0.065, price: 18.36 },
        { cat: "FERRAMENTA E PESCA", ref: "4059", desc: "Balde Para Concreto - 12lts - Preta", emb: 24, ipi: 0.0325, price: 6.84 },
        { cat: "FERRAMENTA E PESCA", ref: "4060", desc: "Balde para Concreto/Multiuso - 12lts - Al√ßa Cor", emb: 24, ipi: 0.0325, price: 7.54 },
        { cat: "FERRAMENTA E PESCA", ref: "4061", desc: "Caixa para Massa - 18lts", emb: 12, ipi: 0.0325, price: 11.23 },
        { cat: "FERRAMENTA E PESCA", ref: "4063", desc: "Maleta Master 12\" c/ bandeja removivel - Preta", emb: 12, ipi: 0.065, price: 12.13 },
        { cat: "FERRAMENTA E PESCA", ref: "4065", desc: "Maleta Premium s/ Bandeja - Estojo na Tampa - Preta", emb: 12, ipi: 0.065, price: 24.13 },
        { cat: "FERRAMENTA E PESCA", ref: "4066", desc: "Maleta Premium c/ Bandeja Removivel - Estojo na Tampa - Preta", emb: 12, ipi: 0.065, price: 28.76 },
        { cat: "FERRAMENTA E PESCA", ref: "4067", desc: "Maleta Premium c/ 1 Estojo Articulado - Estojo na Tampa - Preta", emb: 12, ipi: 0.065, price: 31.80 },
        { cat: "FERRAMENTA E PESCA", ref: "4068", desc: "Maleta Master 16\" s/ Bandeja - Estojo na Tampa - Preta", emb: 12, ipi: 0.065, price: 25.15 },
        { cat: "FERRAMENTA E PESCA", ref: "4069", desc: "Maleta Master 16\" c/ Band Remov√≠vel - Estojo na Tampa - Preta", emb: 12, ipi: 0.065, price: 28.14 },
        { cat: "FERRAMENTA E PESCA", ref: "4070", desc: "Organizador Multibox Pequeno - Fundo Preto e Tampa Transp", emb: 12, ipi: 0.065, price: 6.18 },
        { cat: "FERRAMENTA E PESCA", ref: "4071", desc: "Organizador Multibox Pequeno - Transparente", emb: 12, ipi: 0.065, price: 9.00 },
        { cat: "FERRAMENTA E PESCA", ref: "6007", desc: "Estojo Mini-Box c/bandeja - Preto e Tampa Cor", emb: 24, ipi: 0.065, price: 6.70 },
        { cat: "FERRAMENTA E PESCA", ref: "6009", desc: "Organizador Multibox Pescaria - Transparente", emb: 12, ipi: 0.065, price: 18.34 },
        { cat: "FERRAMENTA E PESCA", ref: "6011", desc: "Estojo Isca Box - Cor", emb: 24, ipi: 0.065, price: 5.05 },

        // SOS
        { cat: "SOS", ref: "8001", desc: "Maleta Compacta S.O.S c/1 bandeja articulada - Branca", emb: 9, ipi: 0.065, price: 45.15 },
        { cat: "SOS", ref: "8002", desc: "Maleta Pronto-Socorro c/2 bandejas articuladas - Branca", emb: 6, ipi: 0.065, price: 58.48 },
        { cat: "SOS", ref: "8003", desc: "Maleta Pronto-Socorro c/3 bandejas articuladas - Branca", emb: 6, ipi: 0.065, price: 64.89 },
        { cat: "SOS", ref: "8004", desc: "Estojo Multiuso S.O.S M√©dio - Transparente", emb: 12, ipi: 0.065, price: 18.35 },
        { cat: "SOS", ref: "8011", desc: "Maleta Mini SOS - Branca", emb: 12, ipi: 0.065, price: 20.06 },
        { cat: "SOS", ref: "8012", desc: "Mini Maleta SOS - Branca", emb: 12, ipi: 0.065, price: 5.95 },
        { cat: "SOS", ref: "8013", desc: "Kit 2 Mini Maletas S.O.S (8012)", emb: 12, ipi: 0.065, price: 11.83 },
        { cat: "SOS", ref: "8014", desc: "Estojo Multiuso S.O.S Pequeno - Transparente", emb: 12, ipi: 0.065, price: 9.18 }
    ];

    // --- MAPA DE IMAGENS ---
    // Mapeia "Refer√™ncia-Normalizada" para "Nome-do-Arquivo-Real"
    const imageMap = {
        "1002-12": "1002-12.jpeg", "1002-52": "1002-52.jpeg", "1006-11": "1006-11.jpeg", "1006-41": "1006-41.jpeg",
        "1006-151": "1006-151.jpeg", "1010": "1010.jpeg", "1011": "1011.jpeg", "1012": "1012.jpeg", "1013": "1013.jpeg",
        "1023": "1023.jpeg", "1024": "1024.jpeg", "1025": "1025.jpeg", "1033-48": "1033-48.jpeg", "1033-72": "1033-72.jpeg",
        "1038": "1038.jpeg", "2100": "2100.jpeg", "2102": "2102.jpeg", "2103": "2103.jpeg", "2104": "2104.jpeg",
        "2105": "2105.jpeg", "2106": "2106.jpeg", "2107": "2107.png", "2139": "2139.jpeg", "2140": "2140.jpeg",
        "2141": "2141.jpeg", "2142": "2142.jpeg", "2143": "2143.jpeg", "2144": "2144.jpeg", "2145": "2145.jpeg",
        "2146": "2146.jpeg", "2147": "2147.jpeg", "2148": "2148.jpeg", "2149": "2149.jpeg", "2150": "2150.jpg",
        "2151": "2151.jpeg", "2152": "2152.jpg", "2513": "2513.jpeg", "2601": "2601.jpeg", "2602": "2602.jpeg",
        "2701": "2701.jpeg", "2702": "2702.jpeg", "2703": "2703.jpeg", "2750": "2750.jpeg", "2751": "2751.jpeg",
        "2752": "2752.jpeg", "2753": "2753.jpeg", "2754": "2754.jpeg", "2755": "2755.jpeg", "2802": "2802.jpg",
        "3901": "3901.jpeg", "3905": "3905.jpeg", "3907": "3907.jpeg", "3952": "3952.jpg", "3953": "3953.jpg",
        "3954": "3954.jpeg", "3955": "3955.jpeg", "3956": "3956.jpeg", "3957": "3957.jpeg", "3958": "3958.jpg",
        "3959": "3959.jpg", "3960": "3960.jpg", "4000": "4000.jpeg", "4001": "4001.jpg", "4002": "4002.jpeg",
        "4003": "4003.jpg", "4013": "4013.jpeg", "4016": "4016.jpeg", "4017": "4017.jpeg", "4019": "4019.jpeg",
        "4020": "4020.jpeg", "4029": "4029.jpeg", "4030": "4030.jpeg", "4033": "4033.jpeg", "4035": "4035.jpeg",
        "4037": "4037.jpeg", "4038": "4038.jpg", "4039": "4039.jpeg", "4042": "4042.jpg", "4043": "4043.jpg",
        "4044": "4044.jpeg", "4045": "4045.jpg", "4046": "4046.jpeg", "4047": "4047.jpeg", "4048": "4048.jpg",
        "4049": "4049.jpg", "4050": "4050.jpeg", "4051": "4051.jpg", "4052": "4052.jpg", "4054": "4054.jpeg",
        "4055": "4055.jpg", "4056": "4056.jpeg", "4057": "4057.jpg", "4058": "4058.jpg", "4059": "4059.jpeg",
        "4060": "4060.jpeg", "4061": "4061.jpeg", "4063": "4063.jpeg", "4065": "4065.jpg", "4066": "4066.jpg",
        "4067": "4067.jpg", "4068": "4068.jpg", "4069": "4069.jpg", "4070": "4070.jpg", "4071": "4071.jpg",
        "6007": "6007.jpeg", "6009": "6009.jpeg", "6011": "6011.jpeg", "8001": "8001.jpeg", "8002": "8002.jpg",
        "8003": "8003.jpg", "8004": "8004.jpeg", "8011": "8011.jpg", "8012": "8012.jpeg", "8013": "8013.jpeg",
        "8014": "8014.jpg"
    };

    // --- L√ìGICA DO SISTEMA ---
    
    // Fun√ß√£o utilit√°ria para moeda
    const formatCurrency = (value) => value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
    
    // Agrupamento
    function groupBy(xs, key) {
        return xs.reduce((rv, x) => {
            (rv[x[key]] = rv[x[key]] || []).push(x);
            return rv;
        }, {});
    }

    // Inicializa√ß√£o
    const app = document.getElementById('app');
    const groups = groupBy(rawData, 'cat');
    let cart = {}; // Armazena o pedido

    // Fun√ß√µes de Imagem
    function getImagePath(ref) {
        const normalizedRef = ref.replace('/', '-'); // Troca 1002/12 por 1002-12
        const filename = imageMap[normalizedRef];
        if (filename) {
            return `assets/img/${filename}`;
        }
        return ''; // Retorna vazio se n√£o tiver imagem
    }

    function openImage(element) {
        document.getElementById("imageModal").style.display = "flex";
        document.getElementById("img01").src = element.src;
    }

    function closeImage() {
        document.getElementById("imageModal").style.display = "none";
    }

    // Renderiza√ß√£o Inicial
    function renderTable() {
        let html = '';
        
        for (const [category, items] of Object.entries(groups)) {
            const catId = category.replace(/\s/g, '-');
            html += `<div class="category-block">
                        <div class="category-header" onclick="toggleCategory('${catId}')">
                            <span>${category}</span>
                            <span class="category-subtotal" id="subtotal-${catId}">Subtotal: R$ 0,00</span>
                         </div>
                         <div class="table-responsive" id="table-container-${catId}">
                             <table>
                                <thead>
                                    <tr>
                                        <th class="col-img">FOTO</th>
                                        <th class="col-ref">REF</th>
                                        <th class="col-desc">DESCRI√á√ÉO</th>
                                        <th class="col-emb">EMB</th>
                                        <th class="col-ipi">IPI</th>
                                        <th class="col-price">PRE√áO UN</th>
                                        <th class="col-qty">FARDOS</th>
                                        <th class="col-total">TOTAL+IPI</th>
                                    </tr>
                                </thead>
                                <tbody>`;
            
            items.forEach((item, index) => {
                const uniqueId = `${catId}-${index}`;
                const ipiPercent = (item.ipi * 100).toFixed(2).replace('.', ',');
                const imgPath = getImagePath(item.ref);
                
                // Se tiver imagem, mostra a tag img, sen√£o mostra um placeholder ou nada
                const imgTag = imgPath 
                    ? `<img src="${imgPath}" class="product-thumb" onclick="openImage(this)" onerror="this.src='https://placehold.co/50x50?text=Indisp'; this.onerror=null;">`
                    : `<span style="font-size:0.8em; color:#ccc;">S/ Foto</span>`;

                html += `<tr id="row-${uniqueId}">
                            <td class="col-img">${imgTag}</td>
                            <td class="col-ref">${item.ref}</td>
                            <td class="col-desc">${item.desc}</td>
                            <td class="col-emb">${item.emb}</td>
                            <td class="col-ipi">${ipiPercent}%</td>
                            <td class="col-price">${formatCurrency(item.price)}</td>
                            <td class="col-qty">
                                <input type="number" min="0" 
                                       oninput="updateItem(this, ${item.price}, ${item.emb}, ${item.ipi}, '${uniqueId}', '${category}', '${item.ref}', '${item.desc.replace(/'/g, "\\'")}')" 
                                       placeholder="0" id="input-${uniqueId}">
                            </td>
                            <td class="col-total" id="total-${uniqueId}">R$ 0,00</td>
                         </tr>`;
            });

            html += `</tbody></table></div></div>`;
        }
        app.innerHTML = html;
    }

    renderTable();

    // L√≥gica de Atualiza√ß√£o (Core)
    function updateItem(input, price, emb, ipi, uniqueId, category, ref, desc) {
        const qty = parseInt(input.value) || 0;
        const row = document.getElementById(`row-${uniqueId}`);
        
        // Visual Feedback
        if (qty > 0) {
            row.classList.add('active-row');
        } else {
            row.classList.remove('active-row');
        }

        // C√°lculos
        const totalBase = price * emb * qty;
        const totalIPI = totalBase * ipi;
        const totalFinal = totalBase + totalIPI;

        // Atualizar objeto do carrinho
        if (qty > 0) {
            cart[uniqueId] = {
                ref, desc, qty, price, emb, ipi,
                totalBase, totalIPI, totalFinal,
                category
            };
        } else {
            delete cart[uniqueId];
        }

        // Atualizar UI da linha
        document.getElementById(`total-${uniqueId}`).innerText = totalFinal > 0 ? formatCurrency(totalFinal) : 'R$ 0,00';

        recalculateTotals();
    }

    function recalculateTotals() {
        let grandBase = 0;
        let grandIPI = 0;
        let grandFinal = 0;
        const catSubtotals = {};

        // Somar carrinho
        Object.values(cart).forEach(item => {
            grandBase += item.totalBase;
            grandIPI += item.totalIPI;
            grandFinal += item.totalFinal;

            if (!catSubtotals[item.category]) catSubtotals[item.category] = 0;
            catSubtotals[item.category] += item.totalFinal;
        });

        // Atualizar Totais Globais
        document.getElementById('grand-total-products').innerText = formatCurrency(grandBase);
        document.getElementById('grand-total-ipi').innerText = formatCurrency(grandIPI);
        document.getElementById('grand-total-final').innerText = formatCurrency(grandFinal);

        // Atualizar Subtotais de Categoria
        document.querySelectorAll('.category-subtotal').forEach(el => {
            const catId = el.id.replace('subtotal-', '').replace(/-/g, ' '); // Reverter replace simples
            // Busca aproximada pois ids CSS n√£o aceitam espa√ßos
            const matchingCat = Object.keys(catSubtotals).find(key => key.replace(/\s/g, '-') === el.id.replace('subtotal-', ''));
            
            const val = matchingCat ? catSubtotals[matchingCat] : 0;
            el.innerText = `Subtotal: ${formatCurrency(val)}`;
        });
    }

    // Funcionalidade de Busca
    function filterProducts() {
        const term = document.getElementById('searchInput').value.toLowerCase();
        const rows = document.querySelectorAll('tbody tr');
        let hasResults = false;

        rows.forEach(row => {
            const text = row.innerText.toLowerCase();
            const inputVal = row.querySelector('input').value;
            
            // Mostrar se bater com a busca OU se tiver quantidade preenchida
            if (text.includes(term) || (inputVal && inputVal > 0)) {
                row.style.display = '';
                hasResults = true;
            } else {
                row.style.display = 'none';
            }
        });

        // Ocultar categorias vazias se estiver buscando
        document.querySelectorAll('.category-block').forEach(block => {
            const visibleRows = block.querySelectorAll('tbody tr:not([style*="display: none"])');
            if(term.length > 0) {
                block.style.display = visibleRows.length > 0 ? '' : 'none';
            } else {
                block.style.display = '';
            }
        });
    }

// Gerar Pedido WhatsApp (Vers√£o Segura sem Emojis Quebrados)
    function generateWhatsApp() {
        if (Object.keys(cart).length === 0) {
            alert("O carrinho est√° vazio!");
            return;
        }

        const today = new Date().toLocaleDateString('pt-BR');
        
        // Cabe√ßalho Limpo
        let message = `*PEDIDO MMB - ${today}*\n`;
        message += `----------------------------------\n`;
        
        // Agrupar por categoria
        const itemsByCat = {};
        Object.values(cart).forEach(item => {
            if(!itemsByCat[item.category]) itemsByCat[item.category] = [];
            itemsByCat[item.category].push(item);
        });

        for(const [cat, items] of Object.entries(itemsByCat)) {
            // Categoria em Negrito e Mai√∫scula
            message += `\n*${cat.toUpperCase()}*\n`; 
            
            items.forEach(item => {
                // C√°lculo de unidades totais
                const totalUnits = item.qty * item.emb;
                
                // Formata√ß√£o Num√©rica
                const totalItem = item.totalFinal.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                const priceUnit = item.price.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                
                // Layout do item com tra√ßo simples (-)
                message += `- [${item.ref}] ${item.desc}\n`;
                message += `   ${totalUnits} Unid. x R$ ${priceUnit} = *R$ ${totalItem}*\n`;
            });
        }

        const totalGeral = document.getElementById('grand-total-final').innerText;
        
        // Rodap√© destacado com texto simples
        message += `\n==================================\n`;
        message += `*TOTAL GERAL: ${totalGeral}*`;
        message += `\n==================================`;
        
        // Codifica√ß√£o segura para URL
        const encodedMsg = encodeURIComponent(message);
        window.open(`https://wa.me/?text=${encodedMsg}`, '_blank');
    }

        const totalGeral = document.getElementById('grand-total-final').innerText;
        message += `\n----------------------------------\n`;
        message += `üí∞ *TOTAL GERAL: ${totalGeral}*`;
        message += `\n----------------------------------`;
        
        // Encode e abrir link
        const encodedMsg = encodeURIComponent(message);
        window.open(`https://wa.me/?text=${encodedMsg}`, '_blank');
    }

    function resetForm() {
        if(confirm("Tem certeza que deseja limpar todo o pedido?")) {
            document.querySelectorAll('input[type="number"]').forEach(input => {
                input.value = '';
                // Disparar evento para limpar cores e totais
                input.dispatchEvent(new Event('input')); // For√ßa rec√°lculo
            });
            // Garantir limpeza total
            cart = {};
            recalculateTotals();
            document.querySelectorAll('tr').forEach(r => r.classList.remove('active-row'));
            document.getElementById('searchInput').value = '';
            filterProducts(); // Resetar filtros
        }
    }
</script>

</body>
</html>